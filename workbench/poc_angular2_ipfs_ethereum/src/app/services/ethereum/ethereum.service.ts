import {Injectable} from '@angular/core';
import Web3 from "web3";


@Injectable()
export class EthereumService {


  private _web3: any = null;

  constructor() {
  }

  get web3(): any {
    return this._web3;
  }

  /**
   * Initializes the web3 connection to the given ethereum provider.
   * @returns {Promise<TResult>|Promise<U>}
   */
  initWeb3(provider: string): Promise<any> {
    let promise = new Promise((resolve, reject) => {
      if (this._web3 == null) {
        let httpProvider = new (<any>Web3).providers.HttpProvider(provider);
        this._web3 = new Web3(httpProvider);
        resolve(this._web3);
      } else {
        resolve(this._web3);
      }
    });
    return promise;
  }

  createContract(contractSource: string): Promise<any> {

    let promise = new Promise((resolve, reject) => {
      if (this._web3 != null) {
        let compiled = this._web3.eth.compile.solidity(contractSource);
        let code = compiled.test.code;
        // contract json abi, this is autogenerated using solc CLI
        let abi = compiled.test.info.abiDefinition;
        let myContract;

        // let's assume that coinbase is our account
        this._web3.eth.defaultAccount = this._web3.eth.coinbase;
        // create contract
        console.log("Contract status: " + "transaction sent, waiting for confirmation");
        this._web3.eth.contract(abi).new({data: code}, (err, contract) => {
          if (err) {
            reject(err);
            return;
            // callback fires twice, we only want the second call when the contract is deployed
          } else if (contract.address) {
            myContract = contract;
            console.log("Contract status: " + "Mined");
            console.log('Contract address: ' + myContract.address);
          }
        });
      } else {
        reject(new Error("You have to connect to your ethereum client first!"));
      }
    });
    return promise;
  }

  createTestContract(): Promise<any> {
    // If no contract source set, we create a test contract
    let contractSource = "" +
      "contract test {\n" +
      "   function multiply(uint a) constant returns(uint d) {\n" +
      "       return a * 7;\n" +
      "   }\n" +
      "}\n";
    return this.createContract(contractSource);
  }

  callTestContract(smartContract: any, param:number): Promise<any> {
    let promise = new Promise((resolve, reject) => {
      if (this._web3 != null) {
        // call the contract
        let res = smartContract.multiply(param);
        resolve(res.toString(10));
      } else {
        reject(new Error("You have to connect to your ethereum client first!"));
      }
    });
    return promise;
  }
}
